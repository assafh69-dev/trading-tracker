<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-2PN66RZ312"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-2PN66RZ312');
	</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת מעקב טרייד מתקדמת</title>
	
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>
	
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .account-summary {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .account-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .account-item h4 {
            font-size: 0.9em;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .account-item .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .account-settings {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
            text-align: center;
        }

        .account-input {
            display: inline-block;
            margin: 0 15px;
        }

        .account-input label {
            font-weight: bold;
            margin-left: 10px;
        }

        .account-input input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            width: 150px;
        }

		.risk-settings {
			background: #fff3cd;
			border: 2px solid #ffc107;
			padding: 15px;
			margin: 10px 0;
			border-radius: 8px;
			display: flex;
			gap: 20px;
			align-items: center;
			justify-content: center;
		}

		.fee-settings {
			background: #f3e5f5;
			border: 2px solid #9c27b0;
			padding: 15px;
			margin: 10px 0;
			border-radius: 8px;
			display: flex;
			gap: 20px;
			align-items: center;
			justify-content: center;
		}

		.fee-input {
			display: inline-block;
			margin: 0 10px;
		}

		.fee-input label {
			font-weight: bold;
			margin-left: 8px;
			color: #7b1fa2;
		}

		.fee-input input {
			padding: 6px 10px;
			border: 2px solid #ce93d8;
			border-radius: 5px;
			width: 80px;
			text-align: center;
		}

		@media (max-width: 768px) {
			.fee-settings {
				flex-direction: column;
				gap: 10px;
			}
		}

		.filter-section {
			background: #e3f2fd;
			border: 2px solid #2196f3;
			padding: 20px;
			margin: 15px 0;
			border-radius: 10px;
		}

		.filter-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
			margin-bottom: 15px;
		}

		.filter-group {
			display: flex;
			flex-direction: column;
		}

		.filter-group label {
			font-weight: bold;
			margin-bottom: 5px;
			color: #1976d2;
			font-size: 0.9em;
		}

		.filter-group input, .filter-group select {
			padding: 8px;
			border: 2px solid #bbdefb;
			border-radius: 5px;
			font-size: 13px;
		}

		.filter-controls {
			display: flex;
			gap: 10px;
			justify-content: center;
			flex-wrap: wrap;
		}

		.sort-section {
			margin-top: 15px;
			padding-top: 15px;
			border-top: 1px solid #90caf9;
		}

		@media (max-width: 768px) {
			.filter-grid {
				grid-template-columns: 1fr;
			}
		}


		.risk-input {
			display: inline-block;
			margin: 0 10px;
		}

		.risk-input label {
			font-weight: bold;
			margin-left: 8px;
			color: #856404;
		}

		.risk-input input {
			padding: 6px 10px;
			border: 2px solid #ffc107;
			border-radius: 5px;
			width: 80px;
			text-align: center;
		}

		.risk-exceeded {
			background: #f8d7da !important;
			border-color: #dc3545 !important;
			color: #c0392b !important;
		}

		@media (max-width: 768px) {
			.risk-settings {
				flex-direction: column;
				gap: 10px;
			}
		}

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            border-bottom-color: #3498db;
            color: #3498db;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            font-size: 12px;
        }

        .trades-table th, .trades-table td {
            padding: 8px 6px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .trades-table th {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            font-weight: bold;
            font-size: 11px;
            text-transform: uppercase;
        }

        .trades-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .trades-table tr:hover {
            background: #e3f2fd;
        }

        .profit-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .profit-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .risk-active {
            color: #b7950b;
            font-weight: bold;
        }

        .risk-safe {
            color: #27ae60;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h4 {
            font-size: 1em;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .editable-cell input {
            width: 60px;
            padding: 3px 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 11px;
        }

        .trade-controls {
            display: flex;
            gap: 2px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .status-open {
            background: #f39c12;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
        }

        .status-closed {
            background: #27ae60;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
        }

        @media (max-width: 768px) {
            .account-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .trades-table {
                font-size: 10px;
            }

            .trades-table th, .trades-table td {
                padding: 4px 2px;
            }
        }
		
		/* Toast notifications */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			max-width: 300px;
		}

		.toast {
			background: linear-gradient(45deg, #2c3e50, #3498db);
			color: white;
			padding: 15px 20px;
			border-radius: 8px;
			margin-bottom: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			transform: translateX(400px);
			opacity: 0;
			transition: all 0.3s ease;
			border-right: 4px solid #27ae60;
			font-weight: bold;
		}

		.toast.success {
			border-right-color: #27ae60;
			background: linear-gradient(45deg, #27ae60, #2ecc71);
		}

		.toast.error {
			border-right-color: #e74c3c;
			background: linear-gradient(45deg, #e74c3c, #c0392b);
		}

		.toast.warning {
			border-right-color: #f39c12;
			background: linear-gradient(45deg, #f39c12, #e67e22);
		}

		.toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		@media (max-width: 768px) {
			.toast-container {
				left: 10px;
				right: 10px;
				top: 10px;
				max-width: none;
			}
			
			.toast {
				transform: translateY(-100px);
			}
			
			.toast.show {
				transform: translateY(0);
			}
		}

		
		/* הוסף כאן את הקוד החדש: */
		.settings-toggle {
			background: #3498db;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 16px;
			font-weight: bold;
			margin: 10px 0;
			width: 100%;
			text-align: center;
		}

		.settings-toggle:hover {
			background: #2980b9;
		}

		.settings-collapsible {
			display: none;
			animation: slideDown 0.3s ease;
		}

		.settings-collapsible.active {
			display: block;
		}

		@keyframes slideDown {
			from { opacity: 0; transform: translateY(-10px); }
			to { opacity: 1; transform: translateY(0); }
		}
		
		
		/* Add this CSS to make the Notes column wider */
		.trades-table th:nth-child(16), 
		.trades-table td:nth-child(16) {
			min-width: 200px;
			max-width: 300px;
			word-wrap: break-word;
			white-space: normal;
		}

		/* Also make the Notes input in edit mode wider */
		.trades-table input[type="text"]:nth-child(16) {
			min-width: 180px;
		}
		
		/* Mobile Tabs Fix - ONLY */
		@media (max-width: 768px) {
			.tabs {
				overflow-x: auto;
				white-space: nowrap;
				-webkit-overflow-scrolling: touch;
				scrollbar-width: thin;
				padding-bottom: 5px;
			}
			
			.tab {
				min-width: 85px;
				flex-shrink: 0;
				font-size: 13px;
				padding: 10px 12px;
				margin: 0 2px;
			}
		}
		
		/* Account Summary - Much Smaller for Mobile */
		@media (max-width: 768px) {
			.account-summary {
				grid-template-columns: 1fr 1fr !important; /* Two columns instead of auto-fit */
				gap: 8px !important;
				margin: 10px 0 !important;
			}
			
			.account-item {
				padding: 8px 10px !important; /* Much smaller padding */
				min-height: auto !important;
			}
			
			.account-item h4 {
				font-size: 11px !important; /* Much smaller text */
				margin: 0 0 3px 0 !important;
				font-weight: normal !important;
			}
			
			.account-item .value {
				font-size: 16px !important; /* Reasonable size instead of huge */
				font-weight: bold !important;
				margin: 0 !important;
			}
		}
		
		/* Settings Sections - Better Alignment */
		@media (max-width: 768px) {
			.account-settings, .risk-settings, .fee-settings {
				flex-direction: column !important;
				align-items: center !important;
				text-align: center !important;
				gap: 10px !important;
				padding: 15px !important;
			}
			
			.account-input, .risk-input, .fee-input {
				display: flex !important;
				flex-direction: column !important;
				align-items: center !important;
				width: 100% !important;
				max-width: 280px !important;
				margin: 5px 0 !important;
			}
			
			.account-input label, .risk-input label, .fee-input label {
				margin-bottom: 5px !important;
				font-weight: bold !important;
				font-size: 14px !important;
				text-align: center !important;
			}
			
			.account-input input, .risk-input input, .fee-input input {
				width: 100% !important;
				padding: 10px !important;
				font-size: 16px !important; /* Prevents zoom on iOS */
				text-align: center !important;
				border: 2px solid #ddd !important;
				border-radius: 8px !important;
			}
		}
		
		/* Fix Account Settings alignment specifically */
		@media (max-width: 768px) {
			.account-settings {
				display: flex !important;
				flex-direction: column !important;
				align-items: center !important;
				text-align: center !important;
				gap: 10px !important;
				padding: 15px !important;
			}
			
			.account-settings .account-input {
				display: flex !important;
				flex-direction: column !important;
				align-items: center !important;
				width: 100% !important;
				max-width: 280px !important;
				margin: 5px 0 !important;
			}
			
			.account-settings .account-input label {
				margin-bottom: 5px !important;
				font-weight: bold !important;
				font-size: 14px !important;
				text-align: center !important;
			}
			
			.account-settings .account-input input {
				width: 100% !important;
				padding: 10px !important;
				font-size: 16px !important;
				text-align: center !important;
				border: 2px solid #ddd !important;
				border-radius: 8px !important;
			}
		}

		/* Statistics Cards - Same size as account summary */
		@media (max-width: 768px) {
			.stats-grid {
				grid-template-columns: 1fr 1fr !important; /* Two columns like account summary */
				gap: 8px !important; /* Same gap as account summary */
				margin-top: 15px !important;
			}
			
			.stat-card {
				padding: 8px 10px !important; /* Same padding as account items */
				border-radius: 10px !important;
				min-height: auto !important;
			}
			
			.stat-card h4 {
				font-size: 11px !important; /* Same as account h4 */
				margin: 0 0 3px 0 !important; /* Same spacing */
				font-weight: normal !important;
				opacity: 0.9 !important;
			}
			
			.stat-card .value {
				font-size: 16px !important; /* Same as account values */
				font-weight: bold !important;
				margin: 0 !important;
				text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3) !important;
			}
		}

		/* Also improve stats for desktop - make them same style */
		@media (min-width: 769px) {
			.stat-card {
				padding: 15px !important; /* Same as account items */
			}
			
			.stat-card h4 {
				font-size: 0.9em !important; /* Same as account h4 */
				margin-bottom: 8px !important;
			}
			
			.stat-card .value {
				font-size: 1.8em !important; /* Same as account values */
			}
		}
		
		/* Notes column wider */
		.trades-table th:nth-child(16), 
		.trades-table td:nth-child(16) {
			min-width: 200px !important;
			max-width: 300px !important;
			word-wrap: break-word !important;
			white-space: normal !important;
		}

		/* Notes INPUT field - fill the cell */
		.trades-table td:nth-child(16) input {
			width: calc(100% - 10px) !important;
			min-width: 180px !important;
			max-width: 290px !important;
		}
		
    </style>
</head>
<body>
    <div class="container">
		<div class="toast-container" id="toastContainer"></div>
        <div class="header">
            <h1>📈 מערכת מעקב טרייד מתקדמת</h1>
            <p>ניהול תיק השקעות מקצועי עם ניהול סיכונים</p>
        </div>

		<button class="settings-toggle" onclick="toggleSettings()">
			⚙️ הגדרות חשבון <span id="settingsIcon">🔽</span>
		</button>
		
		<div id="settingsCollapsible" class="settings-collapsible">
			<div class="account-settings">
				<div class="account-input">
					<label>סכום התחלתי ($):</label>
					<input type="number" id="initialBalance" placeholder="10000">
				</div>
				<button class="btn btn-small" onclick="updateAccountBalance()">עדכן יתרה</button>
			</div>
		
			<div class="risk-settings">
				<div class="risk-input">
					<label>ריסק למניה (%):</label>
					<input type="number" id="riskPerStock" step="0.1" value="1.0" placeholder="1.0">
				</div>
				<div class="risk-input">
					<label>ריסק כולל מקסימלי (%):</label>
					<input type="number" id="maxTotalRisk" step="0.5" value="10.0" placeholder="10.0">
				</div>
				<button class="btn btn-small" onclick="updateRiskSettings()">עדכן הגדרות ריסק</button>
			</div>
		
			<div class="fee-settings">
				<div class="fee-input">
					<label>עמלה קבועה ($):</label>
					<input type="number" id="fixedFee" step="0.01" value="5.00" placeholder="5.00">
				</div>
				<div class="fee-input">
					<label>עמלה באחוזים (%):</label>
					<input type="number" id="percentageFee" step="0.001" value="0.05" placeholder="0.05">
				</div>
				<button class="btn btn-small" onclick="updateFeeSettings()">עדכן עמלות</button>
			</div>
		</div>	

        <div class="account-summary">
			<div class="account-item">
				<h4>יתרה התחלתית</h4>
				<div class="value" id="initialBalanceDisplay">$0</div>
			</div>
			<div class="account-item">
				<h4>יתרה כוללת</h4>
				<div class="value" id="totalBalanceDisplay">$0</div>
			</div>
			<div class="account-item">
				<h4>סיכון פעיל</h4>
				<div class="value risk-active" id="activeRiskDisplay">$0</div>
			</div>
			<div class="account-item">
				<h4>סיכון פעיל (%)</h4>
				<div class="value risk-active" id="activeRiskPercentDisplay">0%</div>
			</div>
			<div class="account-item">
				<h4>תשואה כוללת</h4>
				<div class="value" id="totalReturnDisplay">$0</div>
			</div>
			<div class="account-item">
				<h4>תשואה כוללת (%)</h4>
				<div class="value" id="totalReturnPercentDisplay">0%</div>
			</div>
			<div class="account-item">
				<h4>מזומן זמין</h4>
				<div class="value" id="availableCashDisplay">$0</div>
			</div>
		</div>

        <div class="tabs">
			<button class="tab active" onclick="showTab(event, 'trades')">טרייד חדש</button>
			<button class="tab" onclick="showTab(event, 'portfolio')">פורטפוליו</button>
			<button class="tab" onclick="showTab(event, 'stats')">סטטיסטיקות</button>
			<button class="tab" onclick="showTab(event, 'export')">ייצוא</button>
			<button class="tab" onclick="showTab(event, 'about')">אודות</button>  <!-- הוסף את זה -->
		</div>

        <div id="trades" class="tab-content active">
            <div class="form-section">
                <h3>📊 פרטי טרייד חדש</h3>
                <div class="form-grid">
					<div class="form-group">
						<label>סימול</label>
						<input type="text" id="symbol" placeholder="AAPL" autocomplete="off">
					</div>
					<div class="form-group">
						<label>תאריך כניסה</label>
						<input type="date" id="entryDate">
					</div>
					<div class="form-group">
						<label>מחיר כניסה ($)</label>
						<input type="number" id="entryPrice" step="0.01" placeholder="150.00">
					</div>
					<div class="form-group">
						<label>סטופ ראשוני ($)</label>
						<input type="number" id="initialStop" step="0.01" placeholder="145.00">
					</div>
					<div class="form-group">
						<label>לימיט ($)</label>
						<input type="number" id="limitPrice" step="0.01" placeholder="אופציונלי">
						<div style="margin-top: 5px; display: flex; align-items: center; gap: 10px;">
							<label style="font-size: 12px;">R:</label>
							<input type="number" id="rMultiplier" value="3.0" step="0.5" min="0.5" max="20" 
								   style="width: 60px; padding: 3px; text-align: center;">
							<button type="button" class="btn btn-small" onclick="calculateLimitByR()">חשב לימיט</button>
						</div>
					</div>
					<div class="form-group">
						<label>כמות</label>
						<input type="number" id="quantity" placeholder="100" oninput="updateRecommendedQuantity(); updateRiskBoxDisplay();">
						<small id="recommendedQuantity" style="font-weight: bold; margin-top: 3px; display: block;"></small>
						<small id="riskBoxPercentage" style="font-weight: bold; margin-top: 3px; display: block;"></small>
					</div>
					<div class="form-group">
						<label>סוג פוזיציה</label>
						<select id="positionType">
							<option value="Long">Long (קנייה)</option>
							<option value="Short">Short (מכירה)</option>
						</select>
					</div>
					<div class="form-group">
						<label>סוג כניסה</label>
						<select id="entryType">
							<option value="General">כללי</option>
							<option value="Breakout">פריצה</option>
							<option value="Pullback">נסיגה</option>
							<option value="Support">תמיכה</option>
							<option value="Pattern">תבנית</option>
							<option value="News">חדשות</option>
							<option value="Other">אחר</option>
						</select>
					</div>
					<div class="form-group">
						<label>תאריך יציאה (אופציונלי)</label>
						<input type="date" id="exitDate">
					</div>
					<div class="form-group">
						<label>מחיר יציאה ($)</label>
						<input type="number" id="exitPrice" step="0.01" placeholder="אופציונלי">
					</div>
					<div class="form-group">
						<label>עמלות ($)</label>
						<input type="number" id="fees" step="0.01" value="0" onblur="showCalculatedFee()">
						<small id="calculatedFee" style="font-weight: bold; margin-top: 3px; display: block; color: #9c27b0;"></small>
					</div>
				</div>
                <div class="form-group">
                    <label>הערות</label>
                    <input type="text" id="notes" placeholder="הערות על הטרייד...">
                </div>
                <button class="btn" onclick="addTrade()">הוסף טרייד</button>
            </div>
        </div>

        <div id="portfolio" class="tab-content">
			<div class="filter-section">
				<h4 style="margin-bottom: 15px; color: #1976d2;">🔍 סינון ומיון</h4>
				
				<div class="filter-grid">
					<div class="filter-group">
						<label>חיפוש טקסט</label>
						<input type="text" id="searchText" placeholder="סימול או הערות...">
					</div>
					
					<div class="filter-group">
						<label>מתאריך</label>
						<input type="date" id="dateFrom">
					</div>
					
					<div class="filter-group">
						<label>עד תאריך</label>
						<input type="date" id="dateTo">
					</div>
					
					<div class="filter-group">
						<label>סטטוס</label>
						<select id="statusFilter">
							<option value="all">הכל</option>
							<option value="open">רק פתוחים</option>
							<option value="closed">רק סגורים</option>
						</select>
					</div>
					
					<div class="filter-group">
						<label>סוג פוזיציה</label>
						<select id="positionFilter">
							<option value="all">הכל</option>
							<option value="Long">Long</option>
							<option value="Short">Short</option>
						</select>
					</div>
					
					<div class="filter-group">
						<label>רווח/הפסד</label>
						<select id="profitFilter">
							<option value="all">הכל</option>
							<option value="profit">רק רווחיים</option>
							<option value="loss">רק מפסידים</option>
						</select>
					</div>
				</div>
				
				<div class="sort-section">
					<div class="filter-group" style="max-width: 200px; margin: 0 auto;">
						<label>מיון לפי</label>
						<select id="sortBy">
							<option value="date-desc">תאריך (חדש לישן)</option>
							<option value="date-asc">תאריך (ישן לחדש)</option>
							<option value="symbol">סימול</option>
							<option value="profit-desc">רווח (גבוה לנמוך)</option>
							<option value="profit-asc">רווח (נמוך לגבוה)</option>
						</select>
					</div>
				</div>
				
				<div class="filter-controls">
					<button class="btn btn-small" onclick="applyFilters()">🔍 חפש</button>
					<button class="btn btn-small btn-warning" onclick="clearFilters()">🗑️ נקה סינון</button>
				</div>
			</div>
		
            <div class="form-section">
                <h3>📋 פורטפוליו פעיל</h3>
				<div style="text-align: center; margin-bottom: 15px;">
					<button class="btn btn-success" onclick="refreshMarketPrices()">
						🔄 עדכן מחירים מהשוק
					</button>
					<button class="btn btn-danger" onclick="clearAllTrades()" style="margin-left: 15px;">
						🗑️ מחק כל הטריידים
					</button>
					<span id="priceUpdateStatus" style="margin-right: 15px; font-weight: bold;"></span>
				</div>
                <div style="overflow-x: auto;">
                    <table class="trades-table" id="tradesTable">
                        <thead>
                            <tr>
								<th>סטטוס</th>
								<th>סימול</th>
								<th>תאריך</th>
								<th>מחיר כניסה</th>
								<th>כמות</th>
								<th>סוג</th>
								<th>סטופ ראשוני</th>
								<th>סטופ נוכחי</th>
								<th>לימיט</th>
								<th>מחיר אחרון</th>
								<th>קופסת ריסק (%)</th>
								<th>סיכון פעיל</th>
								<th>רווח/הפסד</th>
								<th>%</th>
								<th>עמלות</th>
								<th>הערות</th>
								<th>פעולות</th>
							</tr>
                        </thead>
                        <tbody id="tradesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="stats" class="tab-content">
            <div class="form-section">
                <h3>📈 סטטיסטיקות ביצועים</h3>
                <div class="stats-grid" id="statsGrid">
                </div>
            </div>
        </div>

        <div id="export" class="tab-content">
            <div class="form-section">
                <h3>📤 ייצוא נתונים</h3>
                <textarea id="exportData" style="width: 100%; height: 300px; margin-top: 15px; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-family: monospace;" readonly></textarea>
                <br><br>
                <button class="btn" onclick="exportToCSV()">עדכן נתונים לייצוא</button>
				<button class="btn btn-success" onclick="downloadCSV()">📥 הורד קובץ CSV</button>
                <button class="btn btn-danger" onclick="clearAllData()">נקה הכל</button>
				<hr style="margin: 20px 0;">
				
				<h4 style="text-align: center; color: #2c3e50;">📊 ייבוא מברוקר</h4>
				<div style="text-align: center;">
					<button class="btn btn-warning" onclick="createImportTable()">🔄 יצור טבלת ייבוא</button>
					<button class="btn btn-success" onclick="importFromBroker()">📥 ייבא מטבלת ההמרה</button>
				</div>
				<p style="text-align: center; font-size: 12px; color: #666; margin-top: 10px;">
					יצור טבלה ריקה להעתקת נתונים מהברוקר, ואז ייבא אותם לתוכנית
				</p>
				
				<hr style="margin: 20px 0;">
				
				<h4 style="text-align: center; color: #2c3e50;">☁️ Google Sheets - סנכרון בענן</h4>
				<div style="text-align: center;">
					<button class="btn btn-success" onclick="connectToGoogleSheets()">🔗 התחבר לGoogle Sheets</button>
					<button class="btn" onclick="saveToGoogleSheets()">☁️ שמור לענן</button>
					<button class="btn btn-warning" onclick="loadFromGoogleSheets()">📥 טען מהענן</button>
				</div>
            </div>
        </div>

		<div id="about" class="tab-content">
			<div class="form-section">
				<h3>📋 אודות Trading Tracker</h3>
				
				<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
					<h2 style="margin: 0 0 10px 0;">🚀 מערכת מעקב טריידים מקצועית</h2>
					<p style="margin: 0; opacity: 0.9;">ניהול ריסק מתקדם עם סנכרון ענן</p>
				</div>
				
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
					<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #3498db;">
						<h4 style="color: #2c3e50; margin-bottom: 10px;">🎯 התחלה מהירה</h4>
						<ol style="margin: 0; padding-right: 20px;">
							<li>הזן יתרה התחלתי</li>
							<li>לחץ "התחבר לGoogle Sheets"</li>
							<li>אשר גישה (בטוח לחלוטין)</li>
							<li>התחל להוסיף טריידים!</li>
						</ol>
					</div>
					
					<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #27ae60;">
						<h4 style="color: #2c3e50; margin-bottom: 10px;">✨ פיצ'רים</h4>
						<ul style="margin: 0; padding-right: 20px;">
							<li>ניהול סיכונים אוטומטי</li>
							<li>חישוב עמלות חכם</li>
							<li>סנכרון בין מכשירים</li>
							<li>סטטיסטיקות מתקדמות</li>
						</ul>
					</div>
				</div>
				
				<div style="background: #e8f5e8; padding: 15px; border-radius: 10px; border: 2px solid #27ae60; margin: 20px 0;">
					<h4 style="color: #2c3e50; margin-bottom: 10px;">👨‍💻 פותח על ידי</h4>
					<p style="margin: 5px 0;"><strong>Assaf Harari</strong> בשיתוף <strong>Claude (Anthropic)</strong></p>
					<p style="margin: 5px 0;">📧 יצירת קשר: <strong>assafh69@gmail.com</strong></p>
				</div>
				
				<div style="background: #fff3cd; padding: 12px; border-radius: 8px; border: 1px solid #ffc107; text-align: center;">
					<small style="color: #856404;">🔒 המערכת שומרת נתונים ב-Google Sheets שלך בלבד. אין גישה לטבלאות אחרות.</small>
				</div>
			</div>
			
			<!-- User Guide Section -->
			<div class="form-section">
				<button class="settings-toggle" onclick="toggleUserGuide()">
					📖 מדריך משתמש <span id="guideIcon">🔽</span>
				</button>
				
				<div id="userGuideCollapsible" class="settings-collapsible">
					<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: right; line-height: 1.6;">
						
						<h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">🎯 מה מיוחד במערכת?</h3>
						<p><strong>ניהול סיכונים חכם:</strong> המערכת מחשבת אוטומטית כמה מניות לקנות על סמך הסיכון שהגדרת.</p>
						<p><strong>מכירה חלקית:</strong> אפשר למכור חלק מהפוזיציה ולהשאיר את השאר פתוח.</p>
						<p><strong>סנכרון ענן:</strong> הנתונים נשמרים ב-Google Sheets ומסונכרנים בין כל המכשירים.</p>
						
						<h3 style="color: #2c3e50; border-bottom: 2px solid #27ae60; padding-bottom: 10px; margin-top: 25px;">🚀 התחלה מהירה</h3>
						<ol style="padding-right: 20px;">
							<li><strong>הגדרות בסיסיות:</strong> לחץ על "⚙️ הגדרות חשבון" והזן את גודל התיק ואחוז הסיכון למניה</li>
							<li><strong>חיבור לענן:</strong> בטאב "ייצוא" לחץ על "🔗 התחבר לGoogle Sheets" ואשר הרשאה</li>
							<li><strong>טרייד ראשון:</strong> הזן סימול, מחיר כניסה וסטופ - המערכת תמליץ על כמות</li>
							<li><strong>שמירה:</strong> לחץ "☁️ שמור לענן" כדי לשמור את הנתונים</li>
						</ol>
						
						<h3 style="color: #2c3e50; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; margin-top: 25px;">📊 הזנת טרייד</h3>
						<p><strong>כמות מומלצת:</strong> המערכת מציעה כמות אוטומטית - אתה יכול לקבל או לשנות</p>
						<p><strong>חצי כמות:</strong> להקטין סיכון - הזן חצי מהכמות המומלצת</p>
						<p><strong>כפתורי R:</strong> מחשב אוטומטית מחיר לימיט (1R = רווח שווה לסיכון)</p>
						<p><strong>סוג כניסה:</strong> תעד למה נכנסת (פריצה, תמיכה, תבנית וכו')</p>
						
						<h3 style="color: #2c3e50; border-bottom: 2px solid #f39c12; padding-bottom: 10px; margin-top: 25px;">🎯 ניהול פורטפוליו</h3>
						<p><strong>עריכת שדות:</strong> לחץ על שדות בטבלה לעריכה מהירה</p>
						<p><strong>סגירת טרייד:</strong> כפתור "סגירה" מציע אפשרויות - סטופ, לימיט, מחיר ידני, מלא או חלקי</p>
						<p><strong>סינון:</strong> חפש לפי סימול, תאריכים, סטטוס או רווחיות</p>
						<p><strong>מעקב סיכונים:</strong> הסיכון הפעיל מתעדכן אוטומטית</p>
						
						<h3 style="color: #2c3e50; border-bottom: 2px solid #9b59b6; padding-bottom: 10px; margin-top: 25px;">☁️ עבודה בענן</h3>
						<p><strong>שמירה:</strong> "☁️ שמור לענן" שומר את כל הטריידים ב-Google Sheets</p>
						<p><strong>טעינה:</strong> "📥 טען מהענן" מביא נתונים מכל מכשיר</p>
						<p><strong>עריכה ישירה:</strong> אפשר לערוך גם ישירות ב-Google Sheets</p>
						
						<h3 style="color: #2c3e50; border-bottom: 2px solid #1abc9c; padding-bottom: 10px; margin-top: 25px;">💡 טיפים מתקדמים</h3>
						<p><strong>ניהול סיכון:</strong> אל תחרוג מהסיכון המקסימלי - המערכת תזהיר אותך</p>
						<p><strong>מכירות חלקיות:</strong> מכור חלק ברווח ותן לשאר לרוץ</p>
						<p><strong>תיעוד:</strong> השתמש בשדה הערות לרשום מסקנות</p>
						
						<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border: 2px solid #27ae60; margin-top: 20px; text-align: center;">
							<h4 style="color: #2c3e50; margin-bottom: 10px;">🔒 פרטיות ואבטחה</h4>
							<p style="margin: 5px 0;">הנתונים נשמרים רק ב-Google Sheets שלך</p>
							<p style="margin: 5px 0;">אין גישה למידע שלך מגורמים חיצוניים</p>
						</div>
						
					</div>
				</div>
			</div>

		</div>
		
		<!-- Comprehensive Close Modal -->
		<div id="closeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
			<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #f8f9fa; padding: 30px; border-radius: 15px; min-width: 350px; text-align: center;">
				<h3 style="margin-bottom: 20px; color: #2c3e50;">סגירת טרייד</h3>
				
				<div style="margin-bottom: 15px; text-align: right;">
					<label style="display: block; margin-bottom: 5px;"><strong>סימול:</strong></label>
					<span id="modalSymbol" style="font-size: 18px; color: #2c3e50;"></span>
				</div>
				
				<div style="margin-bottom: 15px; text-align: right;">
					<label style="display: block; margin-bottom: 5px;"><strong>כמות זמינה:</strong></label>
					<span id="modalAvailableQty" style="font-size: 16px; color: #27ae60;"></span>
				</div>
				
				<!-- Price Selection -->
				<div style="margin-bottom: 20px; text-align: right;">
					<label style="display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50;">בחירת מחיר סגירה:</label>
					<div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;">
						<button type="button" class="btn btn-small btn-warning" onclick="setClosePrice('stop')">סטופ (<span id="stopPriceDisplay">0</span>)</button>
						<button type="button" class="btn btn-small btn-success" onclick="setClosePrice('limit')">לימיט (<span id="limitPriceDisplay">0</span>)</button>
					</div>
					<div style="text-align: right;">
						<label for="manualClosePrice" style="display: block; margin-bottom: 5px;">מחיר סגירה:</label>
						<input type="number" id="manualClosePrice" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px;" placeholder="הזן מחיר...">
					</div>
				</div>
				
				<!-- Quantity Selection -->
				<div style="margin-bottom: 20px; text-align: right;">
					<label style="display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50;">בחירת כמות למכירה:</label>
					<div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;">
						<button type="button" class="btn btn-small" onclick="setCloseQuantity('full')">מלאה</button>
						<button type="button" class="btn btn-small" onclick="setCloseQuantity('half')">חצי</button>
					</div>
					<div style="text-align: right;">
						<label style="display: block; margin-bottom: 5px;">כמות:</label>
						<input type="number" id="closeQuantity" min="1" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px;">
					</div>
				</div>
				
				<div style="display: flex; gap: 10px; justify-content: center;">
					<button class="btn btn-success" onclick="executeClose()">סגור טרייד</button>
					<button class="btn" onclick="closeCloseModal()">ביטול</button>
				</div>
			</div>
		</div>

	    
    </div>

    <script>
        // Global variables for storing data
        let trades = [];
        let accountData = {
            initialBalance: 0
        };

		// Google Sheets API Configuration
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
		const SPREADSHEET_NAME = 'Trading Tracker Data';

		let gapi_loaded = false;
		let google_loaded = false;
		let access_token = null;
		let spreadsheet_id = null;

		// Initialize Google APIs
		function initializeGoogleAPIs() {
			gapi.load('client', initializeGapiClient);
			google.accounts.id.initialize({
				client_id: '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com',
				callback: handleCredentialResponse,
			});
		}

		async function initializeGapiClient() {
			await gapi.client.init({
				apiKey: 'AIzaSyB25ms_UzbgfY9FnduMwMhGhlvwfVPaTg8',
				discoveryDocs: [DISCOVERY_DOC],
			});
			gapi_loaded = true;
		}

		function handleCredentialResponse(response) {
			// Handle the credential response
			access_token = response.credential;
			showToast('התחברת בהצלחה ל-Google!', 'success');
		}

		async function connectToGoogleSheets() {
		    try {
		        showToast('מתחבר ל-Google Sheets...', 'success');
		        
		        const tokenClient = google.accounts.oauth2.initTokenClient({
		            client_id: '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com',
		            scope: SCOPES,
		            callback: (response) => {
		                access_token = response.access_token;
		                findOrCreateSpreadsheet(); 
		            },
		        });
		        
		        tokenClient.requestAccessToken();
		        
		    } catch (error) {
		        console.error('Error connecting to Google Sheets:', error);
		        showToast('שגיאה בחיבור ל-Google Sheets', 'error');
		    }
		}

		async function findOrCreateSpreadsheet() {
			try {
				console.log('Starting findOrCreateSpreadsheet...'); 
				// Search for existing spreadsheet
				const response = await gapi.client.request({
					path: 'https://www.googleapis.com/drive/v3/files',
					params: {
						q: `name='${SPREADSHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet'`,
						access_token: access_token
					}
				});

				console.log('Response:', response.result.files);
				
				if (response.result.files.length > 0) {
					console.log('Found existing spreadsheet');
					spreadsheet_id = response.result.files[0].id;
					showToast('נמצאה טבלה קיימת!', 'success');
					// Add migration check here
					await checkAndMigrateSpreadsheet();
				} else {
					console.log('No spreadsheet found, creating new one...');
					await createNewSpreadsheet();
				}
				
			} catch (error) {
				console.error('Error in findOrCreateSpreadsheet:', error);
				showToast('שגיאה בחיפוש טבלה', 'error');
			}
		}
		
		async function createNewSpreadsheet() {
			console.log('Creating new spreadsheet...');
			try {
				// Create new spreadsheet
				const response = await gapi.client.request({
					path: 'https://sheets.googleapis.com/v4/spreadsheets',
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${access_token}`,
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						properties: {
							title: SPREADSHEET_NAME
						},
						sheets: [{
							properties: {
								title: 'Trades'
							}
						}]
					})
				});
				
				spreadsheet_id = response.result.spreadsheetId;
				
				// Add headers
				await addHeaders();
				showToast('נוצרה טבלה חדשה!', 'success');
				
			} catch (error) {
				console.error('Error creating spreadsheet:', error);
				showToast('שגיאה ביצירת טבלה', 'error');
			}
		}


		async function addHeaders() {
			const headers = [
				'ID', 'Symbol', 'Entry Date', 'Entry Price', 'Quantity', 'Position Type',
				'Initial Stop', 'Current Stop', 'Limit Price', 'Exit Date', 'Exit Price',
				'Fees', 'Notes', 'Created At', 'Market Price'
			];
			
			try {
				// Add headers row
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheet_id,
					range: 'Trades!A1:O1',  // ← תיקון: O במקום P
					valueInputOption: 'RAW',
					values: [headers]
				});
				
				// Add Google Finance formulas WITHOUT the ' prefix
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheet_id,
					range: 'Trades!O2:O1000',  // ← תיקון: O במקום P
					valueInputOption: 'USER_ENTERED',  // ← זה חשוב!
					values: Array(999).fill(['=IF(OR(ISBLANK(J2), J2="", LEN(TRIM(J2))=0), IFERROR(GOOGLEFINANCE(B2), "N/A"), K2)'])
				});
				
			} catch (error) {
				console.error('Error adding headers:', error);
			}
		}

		async function saveToGoogleSheets() {
			if (!access_token || !spreadsheet_id) {
				showToast('התחבר תחילה ל-Google Sheets', 'warning');
				return;
			}
			
			try {
				showToast('שומר נתונים...', 'success');
				
				// Prepare data
				const values = trades.map(trade => [
					trade.id,
					trade.symbol,
					trade.entryDate,
					trade.entryPrice,
					trade.quantity,
					trade.positionType,
					trade.initialStop,
					trade.currentStop || trade.initialStop,
					trade.limitPrice || '',
					trade.exitDate || '',
					trade.exitPrice || '',
					trade.fees,
					trade.notes,
					trade.createdAt,     // ← תיקון: createdAt במקום entryType
					trade.marketPrice || ''  // ← תיקון: marketPrice
				]);
				
				// Clear existing data and add new
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: spreadsheet_id,
					range: 'Trades!A2:O1000'
				});
				
				if (values.length > 0) {
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheet_id,
						range: 'Trades!A2',
						valueInputOption: 'RAW',
						values: values
					});
				}
				
				showToast(`נשמרו ${trades.length} טריידים בענן!`, 'success');
				
			} catch (error) {
				console.error('Error saving to Google Sheets:', error);
				showToast('שגיאה בשמירה', 'error');
			}
		}
		
			
		let currentTradeForClose = null;

		function showCloseModal(tradeId) {
			const trade = trades.find(t => t.id === tradeId);
			if (!trade) return;
			
			currentTradeForClose = trade;
			
			// Populate modal info
			document.getElementById('modalSymbol').textContent = trade.symbol;
			document.getElementById('modalAvailableQty').textContent = trade.quantity + ' מניות';
			
			// Show current stop and limit prices
			document.getElementById('stopPriceDisplay').textContent = '$' + (trade.currentStop || trade.initialStop).toFixed(2);
			document.getElementById('limitPriceDisplay').textContent = trade.limitPrice ? '$' + trade.limitPrice.toFixed(2) : 'לא הוגדר';
			
			// Set default quantity to full
			document.getElementById('closeQuantity').max = trade.quantity;
			document.getElementById('closeQuantity').value = trade.quantity;
			
			// Clear manual price
			document.getElementById('manualClosePrice').value = '';
			
			document.getElementById('closeModal').style.display = 'block';
		}

		function closeCloseModal() {
			document.getElementById('closeModal').style.display = 'none';
			currentTradeForClose = null;
		}

		function setClosePrice(type) {
			if (!currentTradeForClose) return;
			
			const manualPriceField = document.getElementById('manualClosePrice');
			
			if (type === 'stop') {
				const stopPrice = currentTradeForClose.currentStop || currentTradeForClose.initialStop;
				manualPriceField.value = stopPrice.toFixed(2);
			} else if (type === 'limit') {
				if (currentTradeForClose.limitPrice) {
					manualPriceField.value = currentTradeForClose.limitPrice.toFixed(2);
				} else {
					showToast('לא הוגדר מחיר לימיט לטרייד זה', 'warning');
				}
			}
		}

		function setCloseQuantity(type) {
			if (!currentTradeForClose) return;
			
			const quantityField = document.getElementById('closeQuantity');
			
			if (type === 'full') {
				quantityField.value = currentTradeForClose.quantity;
			} else if (type === 'half') {
				quantityField.value = Math.floor(currentTradeForClose.quantity / 2);
			}
		}

		function executeClose() {
			if (!currentTradeForClose) return;
			
			const closePrice = parseFloat(document.getElementById('manualClosePrice').value);
			const closeQuantity = parseInt(document.getElementById('closeQuantity').value);
			
			if (!closePrice || !closeQuantity || closePrice <= 0 || closeQuantity <= 0) {
				showToast('אנא הזן מחיר וכמות תקינים', 'error');
				return;
			}
			
			if (closeQuantity > currentTradeForClose.quantity) {
				showToast('כמות המכירה גדולה מהכמות הזמינה', 'error');
				return;
			}
			
			// Full close
			if (closeQuantity === currentTradeForClose.quantity) {
				currentTradeForClose.exitDate = new Date().toISOString().split('T')[0];
				currentTradeForClose.exitPrice = closePrice;
				showToast(`נסגר כל הטרייד של ${currentTradeForClose.symbol} במחיר $${closePrice.toFixed(2)}`, 'success');
			} 
			// Partial close
			else {
				// Create new trade for sold portion
				const soldTrade = {
					...currentTradeForClose,
					id: Date.now(),
					quantity: closeQuantity,
					exitDate: new Date().toISOString().split('T')[0],
					exitPrice: closePrice,
					notes: currentTradeForClose.notes + ` (מכירה חלקית)`
				};
				
				// Update original trade
				currentTradeForClose.quantity -= closeQuantity;
				currentTradeForClose.notes += ` (נותרו ${currentTradeForClose.quantity})`;
				
				// Add sold portion to trades array
				trades.push(soldTrade);
				
				showToast(`נמכרו ${closeQuantity} מניות של ${currentTradeForClose.symbol} במחיר $${closePrice.toFixed(2)}. נותרו ${currentTradeForClose.quantity}`, 'success');
			}
			
			closeCloseModal();
			updateAccountDisplay();
			displayTrades();
			saveDataLocally();
		}
		
	
		async function loadFromGoogleSheets() {
			if (!access_token || !spreadsheet_id) {
				showToast('התחבר תחילה ל-Google Sheets', 'warning');
				return;
			}
			
			try {
				showToast('טוען נתונים מהענן...', 'success');
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: spreadsheet_id,
					range: 'Trades!A2:P1000' // O = 15 עמודות (לא P = 16)
				});
				
				const values = response.result.values || [];
				
				// Convert back to trades array - FIXED ORDER
				trades = values
					.filter(row => row[1] && row[1].trim() && row[1] !== '') // Only rows with valid symbol
					.map(row => ({
						id: parseInt(row[0]) || Date.now() + Math.random(),
						symbol: row[1] || '',
						entryDate: row[2] || '',
						entryPrice: parseFloat(row[3]) || 0,
						quantity: parseInt(row[4]) || 0,
						positionType: row[5] || 'Long',
						initialStop: parseFloat(row[6]) || 0,
						currentStop: parseFloat(row[7]) || parseFloat(row[6]) || 0,
						limitPrice: row[8] ? parseFloat(row[8]) : null,
						exitDate: row[9] || null,
						exitPrice: row[10] ? parseFloat(row[10]) : null,
						fees: parseFloat(row[11]) || 0,
						notes: row[12] || '',
						createdAt: row[13] || new Date().toISOString().split('T')[0], // ← תיקון
						marketPrice: row[14] || null  // ← תיקון
					}));
				
				// Update displays
				displayTrades();
				updateAccountDisplay();
				saveDataLocally();
				
				showToast(`נטענו ${trades.length} טריידים מהענן!`, 'success');
				
			} catch (error) {
				console.error('Error loading from Google Sheets:', error);
				showToast('שגיאה בטעינה מהענן', 'error');
			}
		}


        // Initialize page when DOM is loaded
		document.addEventListener('DOMContentLoaded', function() {
			initializeGoogleAPIs();
			loadDataLocally(); // טוען נתונים שמורים
			document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
			document.getElementById('entryPrice').addEventListener('input', updateRecommendedQuantity);
			document.getElementById('initialStop').addEventListener('input', updateRecommendedQuantity);
			// Clear limit price when entry price or stop changes
			document.getElementById('entryPrice').addEventListener('input', clearLimit);
			document.getElementById('initialStop').addEventListener('input', clearLimit);
			document.getElementById('entryPrice').addEventListener('input', showCalculatedFee);
			document.getElementById('quantity').addEventListener('input', showCalculatedFee);
			document.getElementById('entryPrice').addEventListener('input', function() {
				updateRecommendedQuantity();
				updateRiskBoxDisplay();
			});
			document.getElementById('initialStop').addEventListener('input', function() {
				updateRecommendedQuantity();
				updateRiskBoxDisplay();
			});
			document.getElementById('initialStop').addEventListener('blur', function() {
				const errors = validateTradeInputs();
				if (errors.length > 0) {
					showValidationErrors(errors);
				}
			});
			document.getElementById('limitPrice').addEventListener('blur', function() {
				const errors = validateTradeInputs();
				if (errors.length > 0) {
					showValidationErrors(errors);
				}
			});
		});

		function showToast(message, type = 'success') {
			const toastContainer = document.getElementById('toastContainer');
			
			const toast = document.createElement('div');
			toast.className = `toast ${type}`;
			toast.textContent = message;
			
			toastContainer.appendChild(toast);
			
			// Trigger animation
			setTimeout(() => {
				toast.classList.add('show');
			}, 100);
			
			// Remove toast after 3 seconds
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => {
					if (toast.parentNode) {
						toast.parentNode.removeChild(toast);
					}
				}, 300);
			}, 3000);
		}
		
		function showCalculatedFee() {
			const entryPrice = parseFloat(document.getElementById('entryPrice').value);
			const quantity = parseInt(document.getElementById('quantity').value);
			const calculatedFeeDisplay = document.getElementById('calculatedFee');
			const feesInput = document.getElementById('fees');
			
			if (entryPrice && quantity) {
				const autoFee = calculateAutoFee(entryPrice, quantity);
				calculatedFeeDisplay.textContent = `עמלה מחושבת: $${autoFee.toFixed(2)}`;
				
				// עדכן את השדה תמיד (לא רק אם הוא ריק)
				feesInput.value = autoFee.toFixed(2);
			} else {
				calculatedFeeDisplay.textContent = '';
				feesInput.value = '';
			}
		}
		
		function clearLimit() {
			const limitInput = document.getElementById('limitPrice');
			if (limitInput.value) {
				limitInput.value = '';
				limitInput.style.backgroundColor = '#fff3cd'; // Light yellow background
				setTimeout(() => {
					limitInput.style.backgroundColor = ''; // Reset after 2 seconds
				}, 2000);
			}
		}

		function toggleSettings() {
		    const collapsible = document.getElementById('settingsCollapsible');
		    const icon = document.getElementById('settingsIcon');
		    
		    if (collapsible.classList.contains('active')) {
		        collapsible.classList.remove('active');
		        icon.textContent = '🔽';
		    } else {
		        collapsible.classList.add('active');
		        icon.textContent = '🔼';
		    }
		}
	    
		function toggleUserGuide() {
			const collapsible = document.getElementById('userGuideCollapsible');
			const icon = document.getElementById('guideIcon');
			
			if (collapsible.classList.contains('active')) {
				collapsible.classList.remove('active');
				icon.textContent = '🔽';
			} else {
				collapsible.classList.add('active');
				icon.textContent = '🔼';
			}
		}
		
		function updateRiskSettings() {
			const riskPerStock = parseFloat(document.getElementById('riskPerStock').value) || 1.0;
			const maxTotalRisk = parseFloat(document.getElementById('maxTotalRisk').value) || 10.0;
			
			accountData.riskPerStock = riskPerStock;
			accountData.maxTotalRisk = maxTotalRisk;
			
			updateAccountDisplay();
			saveDataLocally();
			showToast('הגדרות הריסק עודכנו', 'success');
		}
		
		function updateFeeSettings() {
			const fixedFee = parseFloat(document.getElementById('fixedFee').value) || 0;
			const percentageFee = parseFloat(document.getElementById('percentageFee').value) || 0;
			
			accountData.fixedFee = fixedFee;
			accountData.percentageFee = percentageFee;
			
			updateAccountDisplay();
			saveDataLocally();
			showToast('הגדרות העמלות עודכנו', 'success');
		}

		function calculateAutoFee(entryPrice, quantity) {
			const tradeValue = entryPrice * quantity;
			const fixedFee = accountData.fixedFee || 5;
			const percentageFee = accountData.percentageFee || 0.05;
			
			return fixedFee + (tradeValue * percentageFee / 100);
		}
		
		function calculateRecommendedQuantity() {
			const entryPrice = parseFloat(document.getElementById('entryPrice').value);
			const initialStop = parseFloat(document.getElementById('initialStop').value);
			const riskPerStock = accountData.riskPerStock || 1.0;
			
			if (!entryPrice || !initialStop || !accountData.initialBalance) {
				return 0;
			}
			
			// חישוב קופסת ריסק באחוזים
			const riskBoxPercent = Math.abs((entryPrice - initialStop) / entryPrice) * 100;
			
			// חישוב כמות מומלצת בדולרים
			const recommendedDollarAmount = (accountData.initialBalance * riskPerStock) / riskBoxPercent;
			
			// חישוב כמות מניות
			const recommendedQuantity = Math.floor(recommendedDollarAmount / entryPrice);
			
			return Math.max(0, recommendedQuantity);
		}

		function updateRecommendedQuantity() {
			const recommended = calculateRecommendedQuantity();
			const quantityInput = document.getElementById('quantity');
			const recommendedDisplay = document.getElementById('recommendedQuantity');
			
			if (recommended > 0) {
				recommendedDisplay.textContent = `מומלץ: ${recommended}`;
				recommendedDisplay.style.color = '#27ae60';
				// אם השדה ריק, מלא אוטומטית
				if (!quantityInput.value) {
					quantityInput.value = recommended;
				}
			} else {
				recommendedDisplay.textContent = '';
			}
		}
		
		function calculateRiskBoxPercentage(trade) {
			if (!trade.entryPrice || !trade.initialStop) {
				return 0;
			}
			
			// קופסת ריסק = המרחק מהטריגר לסטופ באחוזים
			const riskBoxPercent = Math.abs((trade.entryPrice - trade.initialStop) / trade.entryPrice) * 100;
			
			return riskBoxPercent;
		}

		function updateRiskBoxDisplay() {
			const entryPrice = parseFloat(document.getElementById('entryPrice').value);
			const initialStop = parseFloat(document.getElementById('initialStop').value);
			const riskBoxDisplay = document.getElementById('riskBoxPercentage');
			
			if (entryPrice && initialStop) {
				// חישוב קופסת ריסק באחוזים (המרחק מטריגר לסטופ)
				const riskBoxPercent = Math.abs((entryPrice - initialStop) / entryPrice) * 100;
				
				riskBoxDisplay.textContent = `קופסת ריסק: ${riskBoxPercent.toFixed(2)}%`;
				riskBoxDisplay.style.color = '#3498db'; // כחול רגיל
			} else {
				riskBoxDisplay.textContent = '';
			}
		}
		
		function calculateLimitByR() {
			const entryPrice = parseFloat(document.getElementById('entryPrice').value);
			const initialStop = parseFloat(document.getElementById('initialStop').value);
			const rMultiplier = parseFloat(document.getElementById('rMultiplier').value);
			const positionType = document.getElementById('positionType').value;
			
			if (!entryPrice || !initialStop || !rMultiplier) {
				showToast('הזן מחיר כניסה, סטופ ו-R תחילה', 'warning');
				return;
			}
			
			const riskBox = Math.abs(entryPrice - initialStop);
			
			let limitPrice;
			if (positionType === 'Long') {
				limitPrice = entryPrice + (riskBox * rMultiplier);
			} else {
				limitPrice = entryPrice - (riskBox * rMultiplier);
			}
			
			document.getElementById('limitPrice').value = limitPrice.toFixed(2);
			showToast(`לימיט ${rMultiplier}R הוגדר ל-$${limitPrice.toFixed(2)}`, 'success');
		}
		
		
		function validateTradeInputs() {
			const entryPrice = parseFloat(document.getElementById('entryPrice').value);
			const initialStop = parseFloat(document.getElementById('initialStop').value);
			const limitPrice = parseFloat(document.getElementById('limitPrice').value);
			const positionType = document.getElementById('positionType').value;
			
			let errors = [];
			
			if (entryPrice && initialStop) {
				if (positionType === 'Long') {
					// בלונג: מחיר כניסה צריך להיות גדול מהסטופ
					if (entryPrice <= initialStop) {
						errors.push('בפוזיציית Long, מחיר הכניסה צריך להיות גדול מהסטופ');
					}
					// בלונג: לימיט צריך להיות גדול ממחיר הכניסה
					if (limitPrice && limitPrice <= entryPrice) {
						errors.push('בפוזיציית Long, הלימיט צריך להיות גדול ממחיר הכניסה');
					}
				} else if (positionType === 'Short') {
					// בשורט: מחיר כניסה צריך להיות קטן מהסטופ
					if (entryPrice >= initialStop) {
						errors.push('בפוזיציית Short, מחיר הכניסה צריך להיות קטן מהסטופ');
					}
					// בשורט: לימיט צריך להיות קטן ממחיר הכניסה
					if (limitPrice && limitPrice >= entryPrice) {
						errors.push('בפוזיציית Short, הלימיט צריך להיות קטן ממחיר הכניסה');
					}
				}
			}
			
			// בדיקות נוספות
			if (entryPrice && entryPrice <= 0) {
				errors.push('מחיר הכניסה חייב להיות חיובי');
			}

			if (initialStop && initialStop <= 0) {
				errors.push('מחיר הסטופ חייב להיות חיובי');
			}

			const quantity = parseInt(document.getElementById('quantity').value);
			if (quantity && quantity <= 0) {
				errors.push('הכמות חייבת להיות חיובית');
			}

			// בדיקת גודל הטרייד יחסית לתיק
			if (entryPrice && quantity && accountData.initialBalance) {
				const tradeValue = entryPrice * quantity;
				const portfolioPercent = (tradeValue / accountData.initialBalance) * 100;
				if (portfolioPercent > 50) {
					errors.push(`הטרייד מהווה ${portfolioPercent.toFixed(1)}% מהתיק - זה הרבה מאוד!`);
				}
			}

			// בדיקת קופסת ריסק סבירה
			if (entryPrice && initialStop) {
				const riskBoxPercent = Math.abs((entryPrice - initialStop) / entryPrice) * 100;
				if (riskBoxPercent < 1) {
					errors.push('קופסת הריסק קטנה מדי (פחות מ-1%)');
				}
				if (riskBoxPercent > 20) {
					errors.push('קופסת הריסק גדולה מדי (יותר מ-20%)');
				}
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				const errorMessage = errors.join('\n');
				showToast(errorMessage, 'error');
				return true; // יש שגיאות
			}
			return false; // אין שגיאות
		}


		// משתנה גלובלי לשמירת הטריידים המסוננים
		let filteredTrades = [];

		function applyFilters() {
			const searchText = document.getElementById('searchText').value.toLowerCase();
			const dateFrom = document.getElementById('dateFrom').value;
			const dateTo = document.getElementById('dateTo').value;
			const statusFilter = document.getElementById('statusFilter').value;
			const positionFilter = document.getElementById('positionFilter').value;
			const profitFilter = document.getElementById('profitFilter').value;
			const sortBy = document.getElementById('sortBy').value;
			
			// סינון הטריידים
			filteredTrades = trades.filter(trade => {
				// סינון טקסט
				if (searchText && !trade.symbol.toLowerCase().includes(searchText) && 
					!trade.notes.toLowerCase().includes(searchText)) {
					return false;
				}
				
				// סינון תאריכים
				if (dateFrom && trade.entryDate < dateFrom) return false;
				if (dateTo && trade.entryDate > dateTo) return false;
				
				// סינון סטטוס
				const isClosed = isFullyClosed(trade);
				if (statusFilter === 'open' && isClosed) return false;
				if (statusFilter === 'closed' && !isClosed) return false;
				
				// סינון סוג פוזיציה
				if (positionFilter !== 'all' && trade.positionType !== positionFilter) return false;
				
				// סינון רווח/הפסד
				if (profitFilter !== 'all') {
					const { profit } = calculateProfitLoss(trade);
					if (profitFilter === 'profit' && profit <= 0) return false;
					if (profitFilter === 'loss' && profit >= 0) return false;
				}
				
				return true;
			});
			
			// מיון התוצאות
			sortTrades(sortBy);
			
			// הצגת התוצאות המסוננות
			displayFilteredTrades();
			
			showToast(`נמצאו ${filteredTrades.length} טריידים`, 'success');
		}

		function sortTrades(sortBy) {
			switch(sortBy) {
				case 'date-desc':
					filteredTrades.sort((a, b) => new Date(b.entryDate) - new Date(a.entryDate));
					break;
				case 'date-asc':
					filteredTrades.sort((a, b) => new Date(a.entryDate) - new Date(b.entryDate));
					break;
				case 'symbol':
					filteredTrades.sort((a, b) => a.symbol.localeCompare(b.symbol));
					break;
				case 'profit-desc':
					filteredTrades.sort((a, b) => calculateProfitLoss(b).profit - calculateProfitLoss(a).profit);
					break;
				case 'profit-asc':
					filteredTrades.sort((a, b) => calculateProfitLoss(a).profit - calculateProfitLoss(b).profit);
					break;
			}
		}

		function clearFilters() {
			document.getElementById('searchText').value = '';
			document.getElementById('dateFrom').value = '';
			document.getElementById('dateTo').value = '';
			document.getElementById('statusFilter').value = 'all';
			document.getElementById('positionFilter').value = 'all';
			document.getElementById('profitFilter').value = 'all';
			document.getElementById('sortBy').value = 'date-desc';
			
			filteredTrades = [];
			displayTrades(); // חזרה לתצוגה הרגילה
			showToast('הסינון נוקה', 'success');
		}

		function displayFilteredTrades() {
			const tbody = document.getElementById('tradesTableBody');
			tbody.innerHTML = '';
			
			const tradesToShow = filteredTrades.length > 0 ? filteredTrades : trades;
			
			tradesToShow.forEach(trade => {
				const { profit, profitPercent } = calculateProfitLoss(trade);
				const risk = calculateTradeRisk(trade);
				const isClosed = isFullyClosed(trade);
				const riskBoxPercent = calculateRiskBoxPercentage(trade);
				
				const row = tbody.insertRow();
				
				const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
				const riskClass = risk > 0 ? 'risk-active' : 'risk-safe';
				
				row.innerHTML = `
					<td><span class="${isClosed ? 'status-closed' : 'status-open'}">${isClosed ? 'סגור' : 'פתוח'}</span></td>
					<td>${trade.symbol}</td>
					<td>${trade.entryDate}</td>
					
					<!-- Entry Price - EDITABLE -->
					<td class="editable-cell">
						<input type="number" step="0.01" value="${trade.entryPrice.toFixed(2)}" 
							   onchange="updateTradeField(${trade.id}, 'entryPrice', this.value)" ${isClosed ? 'disabled' : ''}>
					</td>
					
					<!-- Quantity - EDITABLE -->
					<td class="editable-cell">
						<input type="number" value="${trade.quantity}" 
							   onchange="updateTradeField(${trade.id}, 'quantity', this.value)" ${isClosed ? 'disabled' : ''}>
					</td>
					
					<td>${trade.positionType}</td>
					
					<!-- Initial Stop - EDITABLE -->
					<td class="editable-cell">
						<input type="number" step="0.01" value="${trade.initialStop.toFixed(2)}" 
							   onchange="updateTradeField(${trade.id}, 'initialStop', this.value)" ${isClosed ? 'disabled' : ''}>
					</td>
					
					<!-- Current Stop (already editable) -->
					<td class="editable-cell">
						<input type="number" step="0.01" value="${(trade.currentStop || trade.initialStop).toFixed(2)}" 
							   onchange="updateTradeField(${trade.id}, 'currentStop', this.value)" ${isClosed ? 'disabled' : ''}>
					</td>
					
					<!-- Limit (already editable) -->
					<td class="editable-cell">
						<input type="number" step="0.01" value="${trade.limitPrice ? trade.limitPrice.toFixed(2) : ''}" 
							   placeholder="לימיט" onchange="updateTradeField(${trade.id}, 'limitPrice', this.value)" ${isClosed ? 'disabled' : ''}>
					</td>
					
					<td>${trade.exitPrice ? '$' + trade.exitPrice.toFixed(2) : (isClosed ? '-' : 'עדכן')}</td>
					<td>${riskBoxPercent.toFixed(2)}%</td>
					<td class="${riskClass}">$${risk.toFixed(2)}</td>
					<td class="${profitClass}">$${profit.toFixed(2)}</td>
					<td class="${profitClass}">${profitPercent.toFixed(2)}%</td>
					
					<!-- Fees - EDITABLE -->
					<td class="editable-cell">
						<input type="number" step="0.01" value="${trade.fees.toFixed(2)}" 
							   onchange="updateTradeField(${trade.id}, 'fees', this.value)" ${isClosed ? 'disabled' : ''}>
					</td>
					
					<!-- Notes - EDITABLE -->
					<td class="editable-cell">
						<input type="text" value="${trade.notes}" 
							   onchange="updateTradeField(${trade.id}, 'notes', this.value)" style="width: 120px;">
					</td>
					
					<!-- Actions -->
					<td class="trade-controls">
						${!isClosed ? `
						<button class="btn btn-small btn-success" onclick="showCloseModal(${trade.id})">סגירה</button>
					` : ''}
						<button class="btn btn-small btn-danger" onclick="deleteTrade(${trade.id})">מחק</button>
					</td>
				`;
			});
		}
		
		
		// פונקציות שמירה וטעינה מקומית
		function saveDataLocally() {
			try {
				localStorage.setItem('tradesData', JSON.stringify(trades));
				localStorage.setItem('accountData', JSON.stringify(accountData));
				showToast('הנתונים נשמרו מקומית', 'success');
			} catch (error) {
				showToast('שגיאה בשמירת הנתונים', 'error');
			}
		}


		function loadDataLocally() {
			try {
				const savedTrades = localStorage.getItem('tradesData');
				const savedAccount = localStorage.getItem('accountData');
				
				if (savedTrades) {
					trades = JSON.parse(savedTrades);
				}
				if (savedAccount) {
					accountData = JSON.parse(savedAccount);
					document.getElementById('initialBalance').value = accountData.initialBalance || '';
					document.getElementById('riskPerStock').value = accountData.riskPerStock || 1.0;
					document.getElementById('maxTotalRisk').value = accountData.maxTotalRisk || 10.0;
					document.getElementById('fixedFee').value = accountData.fixedFee || 5.0;
					document.getElementById('percentageFee').value = accountData.percentageFee || 0.05;
				}
				
				updateAccountDisplay();
				displayTrades();
				showToast('הנתונים נטענו בהצלחה', 'success');
			} catch (error) {
				showToast('שגיאה בטעינת הנתונים', 'error');
			}
		}

		function clearLocalStorage() {
			if (confirm('האם למחוק גם את הנתונים השמורים במכשיר?')) {
				localStorage.removeItem('tradesData');
				localStorage.removeItem('accountData');
				showToast('הנתונים המקומיים נמחקו', 'success');
			}
		}


        function updateAccountBalance() {
			const initialBalance = parseFloat(document.getElementById('initialBalance').value) || 0;
			accountData.initialBalance = initialBalance;
			updateAccountDisplay();
			saveDataLocally();
			showToast('היתרה עודכנה בהצלחה!', 'success');
		}

        function showTab(event, tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'portfolio') {
                displayTrades();
            } else if (tabName === 'stats') {
                displayStats();
            } else if (tabName === 'export') {
                exportToCSV();
            }
            
            updateAccountDisplay();
        }

        function updateAccountDisplay() {
            const totalInvested = calculateTotalInvested();
            const totalProfitLoss = calculateTotalProfitLoss();
            const activeRisk = calculateActiveRisk();
            
            const currentBalance = accountData.initialBalance + totalProfitLoss;
            const availableCash = accountData.initialBalance - totalInvested + totalProfitLoss;
            
            document.getElementById('initialBalanceDisplay').textContent = '$' + (accountData.initialBalance || 0).toLocaleString();
            document.getElementById('totalBalanceDisplay').textContent = '$' + currentBalance.toFixed(2);
            document.getElementById('availableCashDisplay').textContent = '$' + availableCash.toFixed(2);
            document.getElementById('activeRiskDisplay').textContent = '$' + activeRisk.toFixed(2);
            
            const activeRiskPercent = accountData.initialBalance > 0 ? (activeRisk / accountData.initialBalance) * 100 : 0;
            document.getElementById('activeRiskPercentDisplay').textContent = activeRiskPercent.toFixed(2) + '%';
            
            document.getElementById('totalReturnDisplay').textContent = '$' + totalProfitLoss.toFixed(2);
            const totalReturnPercent = accountData.initialBalance > 0 ? (totalProfitLoss / accountData.initialBalance) * 100 : 0;
            document.getElementById('totalReturnPercentDisplay').textContent = totalReturnPercent.toFixed(2) + '%';
            
            const totalReturnEl = document.getElementById('totalReturnDisplay');
            const totalReturnPercentEl = document.getElementById('totalReturnPercentDisplay');
            
            if (totalProfitLoss >= 0) {
				totalReturnEl.className = 'value';
				totalReturnEl.style.color = '#ffffff';
				totalReturnPercentEl.className = 'value';
				totalReturnPercentEl.style.color = '#ffffff';
			} else {
				totalReturnEl.style.color = '#f44336';
				totalReturnPercentEl.style.color = '#f44336';
				totalReturnPercentEl.className = 'value';
				totalReturnPercentEl.style.color = '#ffcdd2';
			}
			
			// בדיקת חריגה מריסק מקסימלי
			const riskSettingsDiv = document.querySelector('.risk-settings');
			const maxRisk = accountData.maxTotalRisk || 10;

			if (activeRiskPercent > maxRisk) {
				riskSettingsDiv.classList.add('risk-exceeded');
				// שדה האחוזים
				document.getElementById('activeRiskPercentDisplay').style.color = '#dc3545';
				document.getElementById('activeRiskPercentDisplay').style.fontWeight = 'bold';
				// שדה הסכום - הוסף את זה!
				document.getElementById('activeRiskDisplay').style.color = '#dc3545';
				document.getElementById('activeRiskDisplay').style.fontWeight = 'bold';
			} else {
				riskSettingsDiv.classList.remove('risk-exceeded');
				// שדה האחוזים
				document.getElementById('activeRiskPercentDisplay').style.color = '';
				document.getElementById('activeRiskPercentDisplay').style.fontWeight = '';
				// שדה הסכום - הוסף את זה!
				document.getElementById('activeRiskDisplay').style.color = '';
				document.getElementById('activeRiskDisplay').style.fontWeight = '';
			}
			
			// בדיקת מזומן שלילי
			if (availableCash < 0) {
				document.getElementById('availableCashDisplay').style.color = '#f44336';
				document.getElementById('availableCashDisplay').style.fontWeight = 'bold';
				if (Math.abs(availableCash) > accountData.initialBalance * 0.1) { // אזהרה אם חריגה מעל 10%
					showToast(`⚠️ חריגת מזומן: ${Math.abs(availableCash).toFixed(0)}$`, 'warning');
				}
			} else {
				document.getElementById('availableCashDisplay').style.color = '';
				document.getElementById('availableCashDisplay').style.fontWeight = '';
			}
        }

        function calculateTotalInvested() {
            return trades.reduce((total, trade) => {
                if (!isFullyClosed(trade)) {
                    const remainingQuantity = getRemainingQuantity(trade);
                    return total + (trade.entryPrice * remainingQuantity);
                }
                return total;
            }, 0);
        }

        function calculateTotalProfitLoss() {
            return trades.reduce((total, trade) => {
                const { profit } = calculateProfitLoss(trade);
                return total + profit;
            }, 0);
        }

        function calculateActiveRisk() {
            return trades.reduce((total, trade) => {
                if (!isFullyClosed(trade)) {
                    const risk = calculateTradeRisk(trade);
                    return total + Math.max(0, risk);
                }
                return total;
            }, 0);
        }

        function addTrade() {
		
			// בדיקת ולידציות תחילה
			const validationErrors = validateTradeInputs();
			if (showValidationErrors(validationErrors)) {
				return; // עצור אם יש שגיאות
			}
	
            const symbol = document.getElementById('symbol').value.trim();
            const entryDate = document.getElementById('entryDate').value;
            const entryPrice = parseFloat(document.getElementById('entryPrice').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const positionType = document.getElementById('positionType').value;
            const initialStop = parseFloat(document.getElementById('initialStop').value);
            const exitDate = document.getElementById('exitDate').value;
            const exitPrice = parseFloat(document.getElementById('exitPrice').value) || null;
            const feesInput = document.getElementById('fees').value;
			let calculatedFees;

			// אם השדה ריק או 0 - חשב אוטומטי
			if (!feesInput || feesInput === '0') {
				calculatedFees = calculateAutoFee(entryPrice, quantity);
				showToast(`עמלה חושבה אוטומטית: $${calculatedFees.toFixed(2)}`, 'success');
			} else {
				calculatedFees = parseFloat(feesInput);
			}
            const notes = document.getElementById('notes').value;

            if (!symbol || !entryDate || isNaN(entryPrice) || isNaN(quantity) || isNaN(initialStop)) {
                showToast('אנא מלא את כל השדות הנדרשים (סימול, תאריך כניסה, מחיר כניסה, כמות, סטופ ראשוני)');
                return;
            }

            const trade = {
				id: Date.now(),
				symbol: symbol.toUpperCase(),
				entryDate,
				entryPrice,
				quantity,
				positionType,
				entryType: document.getElementById('entryType').value,
				initialStop,
				currentStop: initialStop,
				limitPrice: parseFloat(document.getElementById('limitPrice').value) || null, // הוסף שורה זו
				exitDate: exitDate || null,
				exitPrice: exitPrice,
				fees: calculatedFees,
				notes
			};

            trades.push(trade);
            
            // Clear form
			document.getElementById('symbol').value = '';
			document.getElementById('entryPrice').value = '';
			document.getElementById('quantity').value = '';
			document.getElementById('initialStop').value = '';
			document.getElementById('limitPrice').value = ''; // הוסף שורה זו
			document.getElementById('exitDate').value = '';
			document.getElementById('exitPrice').value = '';
			document.getElementById('entryType').value = 'General';
			document.getElementById('notes').value = '';
			document.getElementById('fees').value = '0';
			document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            
            updateAccountDisplay();
            displayTrades();
			saveDataLocally();
            showToast('הטרייד נוסף בהצלחה!');
        }

		function isFullyClosed(trade) {
			return trade.exitDate !== null && trade.exitDate !== undefined && trade.exitDate !== '';
		}

        function getRemainingQuantity(trade) {
            if (isFullyClosed(trade)) return 0;
            return trade.quantity;
        }

        function calculateTradeRisk(trade) {
            if (isFullyClosed(trade)) return 0;
            
            const remainingQuantity = getRemainingQuantity(trade);
            if (remainingQuantity <= 0) return 0;
            
            const currentStop = trade.currentStop || trade.initialStop;
            
            if (trade.positionType === 'Long' && currentStop >= trade.entryPrice) return 0;
            if (trade.positionType === 'Short' && currentStop <= trade.entryPrice) return 0;
            
            let risk;
            if (trade.positionType === 'Long') {
                risk = (trade.entryPrice - currentStop) * remainingQuantity;
            } else {
                risk = (currentStop - trade.entryPrice) * remainingQuantity;
            }
            
            return Math.max(0, risk);
        }

        function calculateProfitLoss(trade) {
            let profit = 0;
            let profitPercent = 0;
            
            if (trade.exitPrice) {
                const entryValue = trade.entryPrice * trade.quantity;
                const exitValue = trade.exitPrice * trade.quantity;
                
                if (trade.positionType === 'Long') {
                    profit = exitValue - entryValue;
                } else {
                    profit = entryValue - exitValue;
                }
                profit -= trade.fees;
                profitPercent = entryValue > 0 ? (profit / entryValue) * 100 : 0;
            }
            
            return { profit, profitPercent };
        }

        function updateTradeField(tradeId, field, value) {
            const trade = trades.find(t => t.id === tradeId);
            if (trade) {
                if (field === 'currentStop' || field === 'limitPrice') {
                    trade[field] = parseFloat(value) || null;
                }
                updateAccountDisplay();
                displayTrades();
            }
        }

        function closeTrade(tradeId, type) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;
            
            let price;
            
            if (type === 'stop') {
                price = trade.currentStop || trade.initialStop;
            } else if (type === 'limit') {
                price = trade.limitPrice;
                if (!price) {
                    showToast('אנא הזן מחיר לימיט תקין');
                    return;
                }
            } else if (type === 'market') {
                price = prompt('הזן מחיר השוק לסגירת הפוזיציה:');
                if (!price) return;
                price = parseFloat(price);
            }
            
            if (confirm(`האם לסגור את ${trade.symbol} ב-$${price.toFixed(2)}?`)) {
                trade.exitDate = new Date().toISOString().split('T')[0];
                trade.exitPrice = price;
                
                updateAccountDisplay();
                displayTrades();
				saveDataLocally();
                showToast('הטרייד נסגר בהצלחה!');
            }
        }

        function deleteTrade(tradeId) {
            if (confirm('האם אתה בטוח שברצונך למחוק את הטרייד?')) {
                trades = trades.filter(trade => trade.id !== tradeId);
                displayTrades();
                updateAccountDisplay();
				saveDataLocally();
                showToast('הטרייד נמחק בהצלחה!');
            }
        }

        
		function displayTrades() {
			filteredTrades = []; // איפוס הסינון
			displayFilteredTrades(); // שימוש בפונקציה החדשה
		}


		function displayStats() {
			const statsGrid = document.getElementById('statsGrid');
			const totalTrades = trades.length;
			const closedTrades = trades.filter(t => isFullyClosed(t));
			const openTrades = trades.filter(t => !isFullyClosed(t));
			const winningTrades = closedTrades.filter(t => calculateProfitLoss(t).profit > 0);
			const losingTrades = closedTrades.filter(t => calculateProfitLoss(t).profit < 0);
			
			const winRate = closedTrades.length > 0 ? (winningTrades.length / closedTrades.length) * 100 : 0;
			const avgWin = winningTrades.length > 0 ? winningTrades.reduce((sum, t) => sum + calculateProfitLoss(t).profit, 0) / winningTrades.length : 0;
			const avgLoss = losingTrades.length > 0 ? losingTrades.reduce((sum, t) => sum + calculateProfitLoss(t).profit, 0) / losingTrades.length : 0;
			
			// חישוב גורם רווח נכון - סך הרווחים חלקי סך ההפסדים
			const totalWins = winningTrades.reduce((sum, t) => sum + calculateProfitLoss(t).profit, 0);
			const totalLosses = Math.abs(losingTrades.reduce((sum, t) => sum + calculateProfitLoss(t).profit, 0));
			const profitFactor = totalLosses > 0 ? totalWins / totalLosses : (totalWins > 0 ? 999 : 0);
			
			const totalProfit = calculateTotalProfitLoss();
			const totalFees = trades.reduce((sum, t) => sum + t.fees, 0);
			
			statsGrid.innerHTML = `
				<div class="stat-card">
					<h4>סה"כ טריידים</h4>
					<div class="value">${totalTrades}</div>
				</div>
				<div class="stat-card">
					<h4>טריידים פתוחים</h4>
					<div class="value">${openTrades.length}</div>
				</div>
				<div class="stat-card">
					<h4>טריידים סגורים</h4>
					<div class="value">${closedTrades.length}</div>
				</div>
				<div class="stat-card">
					<h4>אחוז רווח</h4>
					<div class="value">${winRate.toFixed(1)}%</div>
				</div>
				<div class="stat-card">
					<h4>רווח ממוצע</h4>
					<div class="value">$${avgWin.toFixed(2)}</div>
				</div>
				<div class="stat-card">
					<h4>הפסד ממוצע</h4>
					<div class="value">$${avgLoss.toFixed(2)}</div>
				</div>
				<div class="stat-card">
					<h4>יחס רווח להפסד</h4>
					<div class="value">${profitFactor.toFixed(2)}</div>
				</div>
				<div class="stat-card">
					<h4>סה"כ עמלות</h4>
					<div class="value">$${totalFees.toFixed(2)}</div>
				</div>
			`;
		}

		function exportToCSV() {
			let csv = 'Symbol,Entry Date,Entry Price,Quantity,Position Type,Initial Stop,Current Stop,Limit Price,Exit Date,Exit Price,Profit/Loss,Risk,Fees,Notes\n';
			
			trades.forEach(trade => {
				const { profit } = calculateProfitLoss(trade);
				const risk = calculateTradeRisk(trade);
				
				csv += `${trade.symbol},${trade.entryDate},${trade.entryPrice},${trade.quantity},${trade.positionType},`;
				csv += `${trade.initialStop},${trade.currentStop || trade.initialStop},${trade.limitPrice || ''},`;
				csv += `${trade.exitDate || ''},${trade.exitPrice || ''},${profit.toFixed(2)},${risk.toFixed(2)},`;
				csv += `${trade.fees},"${trade.notes}"\n`;
			});
			
			document.getElementById('exportData').value = csv;
		}

		function clearAllData() {
			if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים? פעולה זו אינה ניתנת לביטול!')) {
				trades = [];
				accountData = { initialBalance: 0 };
				document.getElementById('initialBalance').value = '';
				displayTrades();
				updateAccountDisplay();
				showToast('כל הנתונים נמחקו בהצלחה!');
			}
		}
		
		function downloadCSV() {
			exportToCSV(); // מעדכן את הנתונים
			const csvContent = document.getElementById('exportData').value;
			
			// יצירת קובץ להורדה
			const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
			const link = document.createElement('a');
			
			if (link.download !== undefined) {
				const url = URL.createObjectURL(blob);
				link.setAttribute('href', url);
				link.setAttribute('download', 'trades_export.csv');
				link.style.visibility = 'hidden';
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
				showToast('קובץ CSV הורד בהצלחה!', 'success');
			} else {
				showToast('הדפדפן לא תומך בהורדת קבצים', 'error');
			}
		}
		
		
		let import_spreadsheet_id = null;

		async function createImportTable() {
			try {
				showToast('🆕 יוצר טבלת ייבוא חדשה במבנה IBKR...', 'info');
				
				// ALWAYS create NEW table - no checking old ones!
				const today = new Date().toISOString().split('T')[0];
				const tableName = `Broker Import Helper ${today}`;
				
				const response = await gapi.client.sheets.spreadsheets.create({
					properties: {
						title: tableName
					}
				});
				
				import_spreadsheet_id = response.result.spreadsheetId;
				localStorage.setItem('import_spreadsheet_id', import_spreadsheet_id);
				
				// Setup the table content
				await setupImportTable();
				
				const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${import_spreadsheet_id}`;
				window.open(spreadsheetUrl, '_blank');
				
				showToast('✅ טבלת IBKR חדשה נוצרה! העתק נתונים ולחץ "ייבא"', 'success');
				
			} catch (error) {
				console.error('Error creating import table:', error);
				showToast('שגיאה ביצירת טבלת ייבוא: ' + error.message, 'error');
			}
		}


		async function setupImportTable() {
			try {
				// First, rename the default sheet to "Broker Data"
				await gapi.client.sheets.spreadsheets.batchUpdate({
					spreadsheetId: import_spreadsheet_id,
					resource: {
						requests: [{
							updateSheetProperties: {
								properties: {
									sheetId: 0,
									title: "Broker Data"
								},
								fields: "title"
							}
						}]
					}
				});
				
				// New IBKR format instructions - הוראות בעמודה F
				const instructions = [
					['', '', '', '', '', '📋 הוראות חדשות: העתק נתונים מ-IBKR החל משורה 7', '', ''],
					['', '', '', '', '', '💡 פורמט IBKR: Date | Symbol | Description | Transaction Type | Quantity | Price | Gross Amount | Commission', '', ''],
					['', '', '', '', '', '✅ טיפ: לחץ "ייבא" באפליקציה לאחר ההעתקה', '', ''],
					['', '', '', '', '', 'שורה לדוגמה:', '', ''],
					['2025-07-10', 'AAPL', 'APPLE INC', 'Buy', '100', '150.50 USD', '-15050.00', '-1.5'],
					['', '', '', '', '', '', '', ''], 
					['Date', 'Symbol', 'Description', 'Transaction Type', 'Quantity', 'Price', 'Gross Amount', 'Commission']
				];
				
				// Add all content - 8 columns, 7 rows
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: import_spreadsheet_id,
					range: 'Broker Data!A1:H7',
					valueInputOption: 'RAW',
					values: instructions
				});
				
				// Format instruction rows and headers
				await formatInstructionRows();
				
			} catch (error) {
				console.error('Error setting up import table:', error);
			}
		}


		async function formatInstructionRows() {
			try {
				await gapi.client.sheets.spreadsheets.batchUpdate({
					spreadsheetId: import_spreadsheet_id,
					resource: {
						requests: [
							// Headers background (row 7 עכשיו!) - 8 עמודות
							{
								repeatCell: {
									range: {
										sheetId: 0,
										startRowIndex: 6, // Row 7 (0-based)
										endRowIndex: 7,   // Row 7
										startColumnIndex: 0,
										endColumnIndex: 8  // 8 עמודות (A-H)
									},
									cell: {
										userEnteredFormat: {
											backgroundColor: {
												red: 0.8,
												green: 0.9,
												blue: 0.8
											},
											textFormat: {
												bold: true
											}
										}
									},
									fields: 'userEnteredFormat.backgroundColor,userEnteredFormat.textFormat.bold'
								}
							}
						]
					}
				});
			} catch (error) {
				console.log('Could not format cells:', error);
			}
		}


		async function importFromBroker() {
			if (!access_token) {
				showToast('התחבר תחילה ל-Google Sheets', 'warning');
				return;
			}
			
			if (!import_spreadsheet_id) {
				showToast('צור תחילה טבלת ייבוא', 'warning');
				return;
			}
			
			try {
				showToast('מייבא נתונים מ-IBKR...', 'success');
				
				// Read data from import table - start from row 7
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: import_spreadsheet_id,
					range: 'Broker Data!A7:H1000'
				});
				
				const values = response.result.values || [];
				
				// DEBUG: Log what we actually got
				console.log('Raw data from spreadsheet:', values);
				console.log('Number of rows found:', values.length);
				
				let importedCount = 0;
				
				// Filter and process rows - new IBKR format
				const validRows = values.filter(row => {
					// Must have at least 8 columns and Symbol in column B (index 1)
					const hasEnoughColumns = row.length >= 8;
					const hasSymbol = row[1] && row[1].trim();
					const hasTransactionType = row[3] && (row[3].trim() === 'Buy' || row[3].trim() === 'Sell');
					
					console.log('Checking row:', row);
					console.log('Has enough columns:', hasEnoughColumns, 'Has symbol:', hasSymbol, 'Has Transaction Type:', hasTransactionType);
					
					return hasEnoughColumns && hasSymbol && hasTransactionType;
				});
				
				console.log('Valid rows after filtering:', validRows);
				
				validRows.forEach(row => {
					// Extract data according to IBKR format:
					// A=Date, B=Symbol, C=Description, D=Transaction Type, E=Quantity, F=Price, G=Gross Amount, H=Commission
					const date = row[0] || '';
					const symbol = row[1] || '';
					const description = row[2] || '';
					const transactionType = row[3] || '';
					const quantity = row[4] || '';
					const priceStr = row[5] || '';
					const grossAmount = row[6] || '';
					const commission = row[7] || '';
					
					console.log('Processing row:', {
						date, symbol, description, transactionType, quantity, priceStr, grossAmount, commission
					});
					
					// Clean price (remove "USD" and spaces)
					const cleanPrice = parseFloat(priceStr.toString().replace(/[^\d.-]/g, ''));
					
					// Clean commission (handle both numbers and strings)
					const cleanCommission = Math.abs(parseFloat(commission.toString().replace(/[^\d.-]/g, '')) || 0);
					
					// Only import BUY orders (entries) and ignore SELL orders for now
					if (transactionType.trim() === 'Buy') {
						const trade = {
							id: Date.now() + Math.random(),
							symbol: symbol.toUpperCase().trim(),
							entryDate: date,
							entryPrice: cleanPrice,
							quantity: Math.abs(parseInt(quantity)) || 0,
							positionType: 'Long',
							initialStop: 0,
							currentStop: 0,
							limitPrice: null,
							// ← הסרתי entryType לחלוטין!
							exitDate: null,
							exitPrice: null,
							fees: cleanCommission,
							notes: 'Imported from broker',
							createdAt: new Date().toISOString().split('T')[0],
							marketPrice: `=GOOGLEFINANCE("${symbol.toUpperCase().trim()}")`
						};
						
						console.log('Creating trade:', trade);
						trades.push(trade);
						importedCount++;
					}
				});
				
				if (importedCount > 0) {
					updateAccountDisplay();
					displayTrades();
					saveDataLocally();
					showToast(`יובאו ${importedCount} טריידים מ-IBKR! 🎉`, 'success');
				} else {
					showToast('לא נמצאו טריידים מסוג Buy לייבוא. בדוק את הנתונים בטבלה.', 'warning');
				}
				
			} catch (error) {
				console.error('Error importing data:', error);
				showToast('שגיאה בייבוא נתונים: ' + error.message, 'error');
			}
		}

		
		async function refreshMarketPrices() {
			if (!access_token || !spreadsheet_id) {
				showToast('התחבר תחילה ל-Google Sheets לעדכון מחירים', 'warning');
				return;
			}
			
			document.getElementById('priceUpdateStatus').textContent = '🔄 מעדכן מחירים...';
			document.getElementById('priceUpdateStatus').style.color = '#3498db';
			
			try {
				// Get current data from Google Sheets (including the new price column)
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: spreadsheet_id,
					range: 'Trades!A2:O1000' // Extended range to include Market Price column
				});
				
				const values = response.result.values || [];
				let updatedCount = 0;
				
				// Update only open trades with market prices
				trades.forEach((trade, index) => {
					if (!isFullyClosed(trade) && values[index] && values[index][14]) { // Column P (index 14)
						const marketPrice = parseFloat(values[index][14]);
						if (!isNaN(marketPrice) && marketPrice > 0) {
							trade.exitPrice = marketPrice; // Using exitPrice as "current price"
							updatedCount++;
						}
					}
				});
				
				// Update displays
				displayTrades();
				updateAccountDisplay();
				saveDataLocally();
				
				document.getElementById('priceUpdateStatus').textContent = `✅ עודכנו ${updatedCount} מחירים`;
				document.getElementById('priceUpdateStatus').style.color = '#27ae60';
				
				setTimeout(() => {
					document.getElementById('priceUpdateStatus').textContent = '';
				}, 3000);
				
			} catch (error) {
				console.error('Error refreshing prices:', error);
				document.getElementById('priceUpdateStatus').textContent = '❌ שגיאה בעדכון';
				document.getElementById('priceUpdateStatus').style.color = '#e74c3c';
				showToast('שגיאה בעדכון מחירים מהשוק', 'error');
			}
		}
		
		function clearAllTrades() {
			// Double confirmation for safety
			const firstConfirm = confirm(
				"❌ האם אתה בטוח שברצונך למחוק את כל הטריידים?\n\n" +
				"פעולה זו תמחק את כל הנתונים ולא ניתן לבטל אותה!"
			);
			
			if (!firstConfirm) return;
			
			const secondConfirm = confirm(
				"⚠️ אישור סופי!\n\n" +
				`יימחקו ${trades.length} טריידים לחלוטין.\n\n` +
				"האם להמשיך?"
			);
			
			if (!secondConfirm) return;
			
			// Clear all trades
			trades = [];
			
			// Update displays
			updateAccountDisplay();
			displayTrades();
			saveDataLocally();
			
			// Save to Google Sheets if connected
			if (access_token && spreadsheet_id) {
				saveToGoogleSheets();
			}
			
			showToast('🗑️ כל הטריידים נמחקו בהצלחה', 'success');
		}

		
		async function checkAndMigrateSpreadsheet() {
			if (!access_token || !spreadsheet_id) return;
			
			try {
				// Check if Market Price column exists
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: spreadsheet_id,
					range: 'Trades!O1:O1' // Check column O header
				});
				
				// If column O doesn't exist or is empty, add it
				if (!response.result.values || !response.result.values[0] || !response.result.values[0][0]) {
					console.log('Market Price column not found. Adding migration...');
					await migrateToNewFormat();
				} else {
					console.log('Market Price column already exists.');
				}
				
			} catch (error) {
				// If error accessing column O, it probably doesn't exist
				console.log('Market Price column not found. Adding migration...');
				await migrateToNewFormat();
			}
		}

		async function migrateToNewFormat() {
			try {
				showToast('מעדכן טבלה לגירסה חדשה...', 'success');
				
				// Add Market Price header
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheet_id,
					range: 'Trades!O1:O1',
					valueInputOption: 'RAW',
					values: [['Market Price']]
				});
				
				// Add the Google Finance formulas starting from row 2
				const formulas = [];
				for (let i = 2; i <= 1000; i++) {
					formulas.push([`=IF(OR(ISBLANK(J${i}), J${i}="", LEN(TRIM(J${i}))=0), IFERROR(GOOGLEFINANCE(B${i}), "N/A"), K${i})`]);
				}
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheet_id,
					range: 'Trades!O2:O1000',
					valueInputOption: 'USER_ENTERED',
					values: formulas
				});
				
				showToast('הטבלה עודכנה בהצלחה! עכשיו יש מחירים מהשוק', 'success');
				
			} catch (error) {
				console.error('Migration error:', error);
				showToast('שגיאה בעדכון הטבלה', 'error');
			}
		}
		
		function convertDateFormat(dateStr) {
			// Convert YYYYMMDD to YYYY-MM-DD
			if (dateStr && dateStr.length === 8) {
				return `${dateStr.substr(0,4)}-${dateStr.substr(4,2)}-${dateStr.substr(6,2)}`;
			}
			return dateStr;
		}

	</script>
</body>	
</html>
